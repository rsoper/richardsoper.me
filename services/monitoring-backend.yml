version: "3.2"

networks:
  monitoring_agents:
    external: true

volumes:
  promtail_config:
    driver: local
    driver_opts:
      type: "nfs"
      o: addr=storage.local,nolock,soft,rw
      device: ":/volume1/swarm/monitoring/promtail"
  loki_config:
    driver: local
    driver_opts:
      type: "nfs"
      o: addr=storage.local,nolock,soft,rw
      device: ":/volume1/swarm/monitoring/loki"

services:
  loki:
    image: grafana/loki:1.5.0
    volumes:
      - loki_config:/etc/loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - monitoring_agents
    logging:
      driver: loki:latest
      options:
        loki-url: "http://logging.richardsoper.me:3100/loki/api/v1/push"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.platform.os == linux]

  promtail:
    image: grafana/promtail:1.5.0
    volumes:
      - /var/log:/var/log
      - promtail_config:/etc/promtail/
    command: -config.file=/etc/promtail/docker-config.yaml
    networks:
      - monitoring_agents
    logging:
      driver: loki:latest
      options:
        loki-url: "http://logging.richardsoper.me:3100/loki/api/v1/push"
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]
