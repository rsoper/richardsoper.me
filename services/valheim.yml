version: '3.7'

networks:
  traefik_swarm:
    external: true

volumes:
  valheim_data:
    driver: local
    driver_opts:
      type: "nfs"
      o: addr=10.0.20.30,nolock,soft,rw
      device: ":/volume1/swarm/valheim/data"

  valheim_config:
    driver: local
    driver_opts:
      type: "nfs"
      o: addr=10.0.20.30,nolock,soft,rw
      device: ":/volume1/swarm/valheim/config"

services: 
  valheim: 
    image: lloesche/valheim-server
    environment:
      - SERVER_NAME=Valkeld
      - SERVER_PASS=Victory
      - UPDATE_IF_IDLE=true
      - TZ=America/Los_Angeles
    cap_add:
      - sys_nice
    volumes: 
      - valheim_config:/config
      - valheim_data:/opt/valheim
    ports: 
      - "2456-2457:2456-2457/udp"
    networks:
      - traefik_swarm
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.udp.routers.valheim.entrypoints=valheim"
        - "traefik.udp.routers.valheim.rule=Host(`valheim.richardsoper.me`)"
        - "traefik.udp.services.valheim.loadbalancer.server.port=2456"